# Merging Clusters

Some of the configuration in an ignition file generated by the `ocne` CLI is
time sensitive.  Assets like join tokens and certificate authority keys have
bound lifetimes.  In some cases this can hinder the ability to deploy a cluster
with multiple nodes.  For example, a cluster administrator may not be able to
provision compute resources with any sort of coordination around when each
reource is provisioned.  If they are created too far apart in time, the tokens
and other key material may no longer be valid.

To accomodate this scenario, the default disposition of Oracle Container Host
for Kubernetes (OCK) is to always boot to Kubernetes.  If no configuration is
provided to the host, or the configuration does not contain any details about
how to initialize or join a Kubernetes cluster, the host will start a single
node cluster.  From there, the individual clusters can be merged into one
big cluster using `ocne cluster join`.  This command takes a node from one
cluster and moves it to another.  In the case of a collection of single node
clusters, the effect is to aggregate them into a single cluster of a desired
size.

# Using a Minimal Configuration

An OCK instance booted without any configuration is not able to be accessed.
There are no default passwords for any users, nor any default ssh key material.
At least some configuration is required to have a useful system.  "Some" is
pretty small.  It can be possible to get away with little more than some
ssh configuration.

Here is a sample ignition file that sets up a user with an ssh key, a static
hostname, allows `wheel` users to log in without a password, and provides a
minimal configuration for the `ocne.service` that will initialize the cluster.

```
{
  "ignition": {
    "version": "3.4.0"
  },
  "passwd": {
    "users": [
      {
        "groups": [
          "wheel"
        ],
        "name": "sshuser",
        "sshAuthorizedKeys": [
          "my ssh key"
        ]
      }
    ]
  },
  "storage": {
    "files": [
      {
        "path": "/etc/hostname",
        "contents": {
          "compression": "",
          "source": "data:,join-worker-1"
        }
      },
      {
        "path": "/etc/sudoers",
        "append": [
          {
            "compression": "",
            "source": "data:,%25wheel%09ALL%3D(ALL)%09NOPASSWD%3A%20ALL"
          }
        ]
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "dropins": [
          {
            "contents": "[Service]\nEnvironment=ACTION=\nNET_INTERFACE=enp1s0",
            "name": "bootstrap.conf"
          }
        ],
        "enabled": true,
        "name": "ocne.service"
      }
    ]
  }
}
```

# Create Two Nodes

Use the above configuration to instantiate two nodes.  They will need to be
adapted to the deployment.  At the very least, the hostnames will have to be
changed and the ssh keys need to be valid.

# Join the Worker Node

To join the worker node, get the kubeconfigs for both the control plane node's
cluster and the worker node's cluster.  From there, use `ocne cluster join` to
put the worker node in the control plane node's cluster.

This example assumes that the names of the nodes are `join-control-plane-1` and
`join-worker-1`.  Adjust the commands to match the environment the nodes are
deployed in.

```
# Fetch the kubeconfigs
$ ssh sshuser@join-control-plane-1 sudo cat /etc/kubernetes/admin.conf > kubeconfig.cp1
$ ssh sshuser@join-worker-1 sudo cat /etc/kubernetes/admin.conf > kubeconfig.w1

# Install minimal cluster components
$ export KUBECONFIG=kubeconfig.cp1
$ ocne application install --namespace kube-flannel --name flannel --release flannel --catalog embedded
$ ocne cluster start --provider none --kubeconfig "$KUBECONFIG" --auto-start-ui=false

# Migrate the worker node
$ ocne cluster join -k kubeconfig.w1 --node join-worker-1 --destination kubeconfig.cp1
```

Once this is done, wait a bit.  It takes 30 or so seconds for the worker node to
reset itself and join the new cluster.

```
$ kubectl get node
NAME                   STATUS   ROLES           AGE     VERSION
join-control-plane-1   Ready    control-plane   2m12s   v1.30.10+1.el8
join-worker-1          Ready    <none>          27s     v1.30.10+1.el8
```
